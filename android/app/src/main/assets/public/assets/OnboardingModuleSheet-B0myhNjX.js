import{j as e}from"./ui-vendor-CRu_cuPE.js";import{r as a,u as Z}from"./react-vendor-DwZQO67Z.js";import{d as Y,s as b,V as Q,L as N,I as E,B as T,C as X,q as I,a as ee,W as te,Y as d,Z as U,_ as W,$ as V,a0 as se,a1 as re,a2 as ae,a3 as ne,K as oe,S as ie,l as le,m as ce,n as de,a4 as ue}from"./index-D4bhw5kJ.js";import{m as H,A as he}from"./animation-vendor-C-lCNj7M.js";import{C as me}from"./chevron-left-DnN1sqg3.js";import{S as A,a as L,b as D,c as R,d as h}from"./select-BN0Wnciu.js";import{S as $}from"./switch-_hpo76TP.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=Y("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),B="dismissed_onboarding_prompts",q=()=>{const[i,p]=a.useState({core:!1,nutrition:!1,pantry:!1,beauty:!1,pets:!1,household:!1}),[o,f]=a.useState(!0),[m,v]=a.useState(new Set);a.useEffect(()=>{x();const l=sessionStorage.getItem(B);l&&v(new Set(JSON.parse(l)))},[]);const x=async()=>{try{const{data:{user:l}}=await b.auth.getUser();if(!l)return;const{data:s,error:y}=await b.from("profiles").select("onboarding_modules").eq("id",l.id).single();if(y)throw y;s!=null&&s.onboarding_modules&&typeof s.onboarding_modules=="object"&&p(s.onboarding_modules)}catch(l){console.error("Error loading onboarding modules:",l)}finally{f(!1)}};return{modules:i,loading:o,isModuleComplete:l=>i[l],completeModule:async l=>{try{const{data:{user:s}}=await b.auth.getUser();if(!s)return!1;const y={...i,[l]:!0},{error:r}=await b.from("profiles").update({onboarding_modules:y}).eq("id",s.id);if(r)throw r;return p(y),!0}catch(s){return console.error("Error completing module:",s),!1}},isDismissedThisSession:l=>m.has(l),dismissPrompt:l=>{const s=new Set(m);s.add(l),v(s),sessionStorage.setItem(B,JSON.stringify(Array.from(s)))},allModulesComplete:()=>Object.values(i).every(l=>l),completionPercentage:()=>{const l=Object.values(i).filter(Boolean).length;return Math.round(l/6*100)},reloadModules:x}},ge=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(1),[m,v]=a.useState(!1),{completeModule:x}=q(),[u,S]=a.useState({name:"",height:"",weight:"",gender:""}),g=(s,y)=>{S(r=>({...r,[s]:y}))},_=()=>f(s=>s+1),w=()=>f(s=>s-1),C=async()=>{v(!0);try{const{data:{user:s}}=await b.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:y}=await b.from("profiles").update({user_name:u.name,user_height:parseFloat(u.height)||null,user_weight:parseFloat(u.weight)||null,user_gender:u.gender}).eq("id",s.id);if(y)throw y;await x("core"),I.success("Profile updated!"),i()}catch(s){console.error("Error saving core profile:",s),I.error("Failed to save profile")}finally{v(!1)}},l={enter:s=>({x:s>0?50:-50,opacity:0}),center:{x:0,opacity:1},exit:s=>({x:s<0?50:-50,opacity:0})};return e.jsxs("div",{className:"flex flex-col h-full max-w-md mx-auto relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-secondary/20",children:e.jsx(H.div,{className:"h-full bg-primary",initial:{width:"0%"},animate:{width:`${o/4*100}%`},transition:{duration:.3}})}),e.jsx("div",{className:"flex-1 flex flex-col justify-center py-8",children:e.jsxs(he,{mode:"wait",custom:o,children:[o===1&&e.jsxs(H.div,{custom:1,variants:l,initial:"enter",animate:"center",exit:"exit",transition:{duration:.3},className:"space-y-8 text-center",children:[e.jsx("div",{className:"flex justify-center mb-8",children:e.jsx("div",{className:"scale-150",children:e.jsx(Q,{})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-3xl font-bold font-['Space_Grotesk']",children:"Welcome to Kaeva"}),e.jsx("p",{className:"text-muted-foreground",children:"Let's get to know you better"})]}),e.jsxs("div",{className:"space-y-4 text-left",children:[e.jsx(N,{htmlFor:"name",children:"What's your name?"}),e.jsx(E,{id:"name",value:u.name,onChange:s=>g("name",s.target.value),placeholder:"Enter your name",className:"text-lg py-6",autoFocus:!0})]})]},"step1"),o===2&&e.jsxs(H.div,{custom:1,variants:l,initial:"enter",animate:"center",exit:"exit",transition:{duration:.3},className:"space-y-8",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h2",{className:"text-3xl font-bold font-['Space_Grotesk']",children:"Height"}),e.jsx("p",{className:"text-muted-foreground",children:"How tall are you?"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 justify-center",children:[e.jsx(E,{type:"number",value:u.height,onChange:s=>g("height",s.target.value),placeholder:"175",className:"text-4xl py-8 text-center w-40 font-bold",autoFocus:!0}),e.jsx("span",{className:"text-xl font-medium text-muted-foreground",children:"cm"})]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"(We use this to calculate your metabolic rate)"})]})]},"step2"),o===3&&e.jsxs(H.div,{custom:1,variants:l,initial:"enter",animate:"center",exit:"exit",transition:{duration:.3},className:"space-y-8",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h2",{className:"text-3xl font-bold font-['Space_Grotesk']",children:"Weight"}),e.jsx("p",{className:"text-muted-foreground",children:"What's your current weight?"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 justify-center",children:[e.jsx(E,{type:"number",value:u.weight,onChange:s=>g("weight",s.target.value),placeholder:"70",className:"text-4xl py-8 text-center w-40 font-bold",autoFocus:!0}),e.jsx("span",{className:"text-xl font-medium text-muted-foreground",children:"kg"})]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"(This helps us personalize your nutrition plan)"})]})]},"step3"),o===4&&e.jsxs(H.div,{custom:1,variants:l,initial:"enter",animate:"center",exit:"exit",transition:{duration:.3},className:"space-y-8",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h2",{className:"text-3xl font-bold font-['Space_Grotesk']",children:"Gender"}),e.jsx("p",{className:"text-muted-foreground",children:"Which best describes you?"})]}),e.jsx("div",{className:"grid gap-4",children:["Male","Female","Non-binary","Prefer not to say"].map(s=>e.jsx("button",{type:"button",onClick:()=>g("gender",s),className:`p-4 rounded-xl border-2 transition-all text-left font-medium ${u.gender===s?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,children:s},s))})]},"step4")]})}),e.jsxs("div",{className:"flex gap-4 mt-8 pt-4 border-t border-border/50",children:[o>1?e.jsxs(T,{variant:"outline",onClick:w,className:"flex-1",children:[e.jsx(me,{className:"mr-2 h-4 w-4"})," Back"]}):e.jsx(T,{variant:"ghost",onClick:p,className:"flex-1 text-muted-foreground",children:"Skip"}),o<4?e.jsxs(T,{onClick:_,className:"flex-[2]",disabled:o===1&&!u.name||o===2&&!u.height||o===3&&!u.weight,children:["Continue ",e.jsx(X,{className:"ml-2 h-4 w-4"})]}):e.jsx(T,{onClick:C,className:"flex-[2]",disabled:m||!u.gender,children:m?"Saving...":"Complete Profile"})]})]})};function z(i){let p;i.gender==="male"?p=10*i.weight+6.25*i.height-5*i.age+5:i.gender==="female"?p=10*i.weight+6.25*i.height-5*i.age-161:p=10*i.weight+6.25*i.height-5*i.age-78;const f=p*{sedentary:1.2,light:1.375,moderate:1.55,active:1.725,very_active:1.9}[i.activityLevel];return Math.round(f)}const xe=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(""),[m,v]=a.useState(""),[x,u]=a.useState(""),[S,g]=a.useState(""),[_,w]=a.useState(""),[C,l]=a.useState(""),[s,y]=a.useState(""),[r,F]=a.useState(!1),{completeModule:M}=q(),G=async t=>{t.preventDefault(),F(!0);try{const{data:{user:n}}=await b.auth.getUser();if(!n)throw new Error("Not authenticated");const c=z({age:parseInt(o),weight:parseFloat(x),height:parseFloat(S),gender:m,activityLevel:_}),k=C.split(",").map(P=>P.trim()).filter(Boolean),j=s.split(",").map(P=>P.trim()).filter(Boolean),{error:O}=await b.from("profiles").update({user_age:parseInt(o),user_gender:m,user_weight:parseFloat(x),user_height:parseFloat(S),user_activity_level:_,calculated_tdee:c,allergies:k,dietary_preferences:j}).eq("id",n.id);if(O)throw O;await M("nutrition"),I.success("Nutrition profile saved!"),i()}catch(n){console.error("Error saving nutrition profile:",n),I.error("Failed to save nutrition profile")}finally{F(!1)}};return e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"age",children:"Age"}),e.jsx(E,{id:"age",type:"number",value:o,onChange:t=>f(t.target.value),placeholder:"25",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"gender",children:"Gender"}),e.jsxs(A,{value:m,onValueChange:v,required:!0,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select"})}),e.jsxs(R,{children:[e.jsx(h,{value:"male",children:"Male"}),e.jsx(h,{value:"female",children:"Female"}),e.jsx(h,{value:"other",children:"Other"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"weight",children:"Weight (kg)"}),e.jsx(E,{id:"weight",type:"number",step:"0.1",value:x,onChange:t=>u(t.target.value),placeholder:"70",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"height",children:"Height (cm)"}),e.jsx(E,{id:"height",type:"number",value:S,onChange:t=>g(t.target.value),placeholder:"175",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"activity",children:"Activity Level"}),e.jsxs(A,{value:_,onValueChange:w,required:!0,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select activity level"})}),e.jsxs(R,{children:[e.jsx(h,{value:"sedentary",children:"Sedentary (little/no exercise)"}),e.jsx(h,{value:"light",children:"Light (1-3 days/week)"}),e.jsx(h,{value:"moderate",children:"Moderate (3-5 days/week)"}),e.jsx(h,{value:"active",children:"Active (6-7 days/week)"}),e.jsx(h,{value:"very_active",children:"Very Active (2x/day)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"allergies",children:"Allergies (comma-separated)"}),e.jsx(E,{id:"allergies",value:C,onChange:t=>l(t.target.value),placeholder:"peanuts, shellfish"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"dietary",children:"Dietary Preferences (comma-separated)"}),e.jsx(E,{id:"dietary",value:s,onChange:t=>y(t.target.value),placeholder:"vegetarian, gluten-free"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:p,className:"flex-1",children:"Cancel"}),e.jsx(T,{type:"submit",disabled:r,className:"flex-1",children:r?"Saving...":"Save"})]})]})},pe=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(""),[m,v]=a.useState(""),[x,u]=a.useState(!1),[S,g]=a.useState(!1),{completeModule:_}=q(),w=async C=>{C.preventDefault(),g(!0);try{const{data:{user:l}}=await b.auth.getUser();if(!l)throw new Error("Not authenticated");const{error:s}=await b.from("profiles").update({preferred_retailer_name:o||null,user_zip_code:m||null,lifestyle_goals:x?["organic_preference"]:[]}).eq("id",l.id);if(s)throw s;await _("pantry"),I.success("Pantry preferences saved!"),i()}catch(l){console.error("Error saving pantry preferences:",l),I.error("Failed to save preferences")}finally{g(!1)}};return e.jsxs("form",{onSubmit:w,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"store",children:"Preferred Store"}),e.jsxs(A,{value:o,onValueChange:f,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select your preferred store"})}),e.jsxs(R,{children:[e.jsx(h,{value:"Whole Foods",children:"Whole Foods"}),e.jsx(h,{value:"Trader Joe's",children:"Trader Joe's"}),e.jsx(h,{value:"Safeway",children:"Safeway"}),e.jsx(h,{value:"Kroger",children:"Kroger"}),e.jsx(h,{value:"Target",children:"Target"}),e.jsx(h,{value:"Walmart",children:"Walmart"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"zipCode",children:"ZIP Code"}),e.jsx(E,{id:"zipCode",value:m,onChange:C=>v(C.target.value),placeholder:"12345",maxLength:5})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{children:"Prefer Organic Products"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We'll prioritize organic options when available"})]}),e.jsx($,{checked:x,onCheckedChange:u})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:p,className:"flex-1",children:"Cancel"}),e.jsx(T,{type:"submit",disabled:S,className:"flex-1",children:S?"Saving...":"Save"})]})]})},fe=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(""),[m,v]=a.useState(""),[x,u]=a.useState(!1),{completeModule:S}=q(),g=async _=>{_.preventDefault(),u(!0);try{const{data:{user:w}}=await b.auth.getUser();if(!w)throw new Error("Not authenticated");const{error:C}=await b.from("profiles").update({beauty_profile:{skinType:o||null,hairType:m||null}}).eq("id",w.id);if(C)throw C;await S("beauty"),I.success("Beauty profile saved!"),i()}catch(w){console.error("Error saving beauty profile:",w),I.error("Failed to save beauty profile")}finally{u(!1)}};return e.jsxs("form",{onSubmit:g,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"skin",children:"Skin Type"}),e.jsxs(A,{value:o,onValueChange:f,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select your skin type"})}),e.jsxs(R,{children:[e.jsx(h,{value:"dry",children:"Dry"}),e.jsx(h,{value:"oily",children:"Oily"}),e.jsx(h,{value:"combination",children:"Combination"}),e.jsx(h,{value:"normal",children:"Normal"}),e.jsx(h,{value:"sensitive",children:"Sensitive"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"hair",children:"Hair Type"}),e.jsxs(A,{value:m,onValueChange:v,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select your hair type"})}),e.jsxs(R,{children:[e.jsx(h,{value:"straight",children:"Straight"}),e.jsx(h,{value:"wavy",children:"Wavy"}),e.jsx(h,{value:"curly",children:"Curly"}),e.jsx(h,{value:"coily",children:"Coily"})]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:p,className:"flex-1",children:"Cancel"}),e.jsx(T,{type:"submit",disabled:x,className:"flex-1",children:x?"Saving...":"Save"})]})]})},ve=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(""),[m,v]=a.useState(""),[x,u]=a.useState(""),[S,g]=a.useState(""),[_,w]=a.useState(!0),[C,l]=a.useState(!1),{completeModule:s}=q(),y=async r=>{r.preventDefault(),l(!0);try{const{data:{user:F}}=await b.auth.getUser();if(!F)throw new Error("Not authenticated");const{error:M}=await b.from("pets").insert({user_id:F.id,name:o,species:m,breed:x||null,age:S?parseInt(S):null,toxic_flags_enabled:_});if(M)throw M;await s("pets"),I.success("Pet profile created!"),i()}catch(F){console.error("Error saving pet profile:",F),I.error("Failed to save pet profile")}finally{l(!1)}};return e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"petName",children:"Pet Name"}),e.jsx(E,{id:"petName",value:o,onChange:r=>f(r.target.value),placeholder:"Buddy",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"species",children:"Species"}),e.jsxs(A,{value:m,onValueChange:v,required:!0,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select species"})}),e.jsxs(R,{children:[e.jsx(h,{value:"dog",children:"Dog"}),e.jsx(h,{value:"cat",children:"Cat"}),e.jsx(h,{value:"bird",children:"Bird"}),e.jsx(h,{value:"rabbit",children:"Rabbit"}),e.jsx(h,{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"breed",children:"Breed (optional)"}),e.jsx(E,{id:"breed",value:x,onChange:r=>u(r.target.value),placeholder:"Golden Retriever"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"age",children:"Age (years, optional)"}),e.jsx(E,{id:"age",type:"number",value:S,onChange:r=>g(r.target.value),placeholder:"3"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{children:"Toxic Food Monitoring"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Get alerts when scanning toxic foods"})]}),e.jsx($,{checked:_,onCheckedChange:w})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:p,className:"flex-1",children:"Cancel"}),e.jsx(T,{type:"submit",disabled:C||!o||!m,className:"flex-1",children:C?"Saving...":"Save"})]})]})},ye=({onComplete:i,onCancel:p})=>{const[o,f]=a.useState(""),[m,v]=a.useState(""),[x,u]=a.useState(""),[S,g]=a.useState(""),[_,w]=a.useState(!1),{completeModule:C}=q(),l=async s=>{s.preventDefault(),w(!0);try{const{data:{user:y}}=await b.auth.getUser();if(!y)throw new Error("Not authenticated");const r=S.split(",").map(M=>M.trim()).filter(Boolean),{error:F}=await b.from("household_members").insert({user_id:y.id,name:o,member_type:m,age:x?parseInt(x):null,allergies:r});if(F)throw F;await C("household"),I.success("Household member added!"),i()}catch(y){console.error("Error saving household member:",y),I.error("Failed to save household member")}finally{w(!1)}};return e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"memberName",children:"Name"}),e.jsx(E,{id:"memberName",value:o,onChange:s=>f(s.target.value),placeholder:"Family member name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"memberType",children:"Type"}),e.jsxs(A,{value:m,onValueChange:v,required:!0,children:[e.jsx(L,{children:e.jsx(D,{placeholder:"Select member type"})}),e.jsxs(R,{children:[e.jsx(h,{value:"adult",children:"Adult"}),e.jsx(h,{value:"child",children:"Child"}),e.jsx(h,{value:"toddler",children:"Toddler"}),e.jsx(h,{value:"elderly",children:"Elderly"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"age",children:"Age (optional)"}),e.jsx(E,{id:"age",type:"number",value:x,onChange:s=>u(s.target.value),placeholder:"25"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"allergies",children:"Allergies (comma-separated, optional)"}),e.jsx(E,{id:"allergies",value:S,onChange:s=>g(s.target.value),placeholder:"peanuts, shellfish"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:p,className:"flex-1",children:"Cancel"}),e.jsx(T,{type:"submit",disabled:_||!o||!m,className:"flex-1",children:_?"Saving...":"Save"})]})]})},je=({onProfileUpdate:i,onComplete:p})=>{const[o,f]=a.useState("idle"),[m,v]=a.useState(""),[x,u]=a.useState(""),[S,g]=a.useState(!1),[_,w]=a.useState(0),{toast:C}=ee(),l=Z(),s=a.useRef(""),y=a.useRef(),r=te({onConnect:async()=>{const t=d.startTimer();if(d.info("connection","Onboarding agent connected"),console.log("ðŸ”Œ Onboarding agent connected"),U({conversationId:s.current,agentType:"onboarding",eventType:"session_start",eventData:{timestamp:new Date().toISOString()}}),d.info("connection","Connection established",{conversationId:s.current,connectionTime:t.elapsed(),agentId:V.onboarding.agentId}),r.sendContextualUpdate)try{const{data:{session:n}}=await b.auth.getSession();if(n!=null&&n.user){const c=await se(n.user.id);if(c&&(c.members.length>0||c.pets.length>0)){const k=`RESUMING ONBOARDING:
${re(c)}`;d.info("context","Injecting resume context",{membersCount:c.members.length,petsCount:c.pets.length,contextLength:k.length}),console.log("ðŸ§  Injecting resume context:",k),await r.sendContextualUpdate(k),d.debug("context","Resume context injected successfully")}else d.debug("context","No resume context to inject (fresh onboarding)")}}catch(n){console.error("âŒ Failed to inject resume context:",n),d.logError("context","Failed to inject resume context",n)}},onDisconnect:()=>{d.info("connection","Onboarding agent disconnected"),console.log("ðŸ”Œ Onboarding agent disconnected"),f("idle"),U({conversationId:s.current,agentType:"onboarding",eventType:"session_end",eventData:{timestamp:new Date().toISOString()}})},onError:t=>{d.logError("connection","Onboarding agent connection error",t),console.error("âŒ Onboarding agent error:",t),C({title:"Connection Error",description:"Voice connection failed. Please try again.",variant:"destructive"}),M()},onMessage:t=>{var n;d.debug("message",`${t.source} transcript received`,{source:t.source,messageLength:(n=t.message)==null?void 0:n.length}),console.log("ðŸ“¨ Onboarding message:",t),t.source==="user"?(v(t.message),W("user",t.message,s.current),U({conversationId:s.current,agentType:"onboarding",eventType:"user_transcript",eventData:{message:t.message},role:"user"}),f("acknowledged"),setTimeout(()=>f("thinking"),150)):t.source==="ai"&&(u(t.message),W("assistant",t.message,s.current),U({conversationId:s.current,agentType:"onboarding",eventType:"agent_transcript",eventData:{message:t.message},role:"assistant"}))},clientTools:{updateProfile:async t=>{const n=d.startTimer();d.debug("tool","updateProfile called",{parameters:t}),console.log("ðŸ”§ updateProfile called:",t);try{const{data:{session:c}}=await b.auth.getSession();if(!(c!=null&&c.user))return console.error("No session for updateProfile"),"ERROR: Not authenticated";let k=null;t.userAge&&t.userWeight&&t.userHeight&&t.userGender&&t.userActivityLevel&&(k=z({age:t.userAge,weight:t.userWeight,height:t.userHeight,gender:t.userGender,activityLevel:t.userActivityLevel}));const j={updated_at:new Date().toISOString()};t.userName&&(j.user_name=t.userName),t.userAge&&(j.user_age=t.userAge),t.userWeight&&(j.user_weight=t.userWeight),t.userHeight&&(j.user_height=t.userHeight),t.userGender&&(j.user_gender=t.userGender),t.userActivityLevel&&(j.user_activity_level=t.userActivityLevel),k&&(j.calculated_tdee=k),t.dietaryPreferences&&(j.dietary_preferences=t.dietaryPreferences),t.allergies&&(j.allergies=t.allergies),t.healthGoals&&(j.health_goals=t.healthGoals),t.lifestyleGoals&&(j.lifestyle_goals=t.lifestyleGoals),t.householdAdults&&(j.household_adults=t.householdAdults),t.householdKids&&(j.household_kids=t.householdKids),(t.skinType||t.hairType)&&(j.beauty_profile={skinType:t.skinType||null,hairType:t.hairType||null});const{error:O}=await b.from("profiles").update(j).eq("id",c.user.id);return O?(d.error("tool","updateProfile database error",{error:O.message,duration:n.elapsed()}),console.error("âŒ updateProfile error:",O),`ERROR: ${O.message}`):(d.info("tool","updateProfile completed successfully",{duration:n.elapsed(),fieldsUpdated:Object.keys(j),hasTDEE:!!k}),console.log("âœ… Profile updated in database:",j),U({conversationId:s.current,agentType:"onboarding",eventType:"tool_call",eventData:{tool:"updateProfile",parameters:t,result:"success"}}),i&&i(j),"SUCCESS: Profile updated")}catch(c){return d.logError("tool","updateProfile exception",c),console.error("âŒ updateProfile exception:",c),`ERROR: ${c instanceof Error?c.message:"Unknown error"}`}},completeConversation:async t=>{const n=d.startTimer();d.info("tool","completeConversation called",{summary:t.summary}),console.log("ðŸŽ‰ completeConversation called:",t);try{const{data:{session:c}}=await b.auth.getSession();if(!(c!=null&&c.user))return"ERROR: Not authenticated";const{data:k}=await b.from("profiles").select("current_household_id, user_name").eq("id",c.user.id).single();if(!(k!=null&&k.current_household_id)){const O=`${(k==null?void 0:k.user_name)||"My"} Household`,{data:P,error:J}=await b.from("households").insert({owner_id:c.user.id,name:O}).select().single();!J&&P&&(await b.from("profiles").update({current_household_id:P.id}).eq("id",c.user.id),console.log("âœ… Household created:",P.id))}const{error:j}=await b.from("profiles").update({onboarding_completed:!0,updated_at:new Date().toISOString()}).eq("id",c.user.id);return j?(d.error("tool","completeConversation database error",{error:j.message,duration:n.elapsed()}),console.error("âŒ completeConversation error:",j),`ERROR: ${j.message}`):(d.info("tool","completeConversation finished successfully",{duration:n.elapsed(),householdCreated:!(k!=null&&k.current_household_id)}),console.log("âœ… Onboarding marked complete"),U({conversationId:s.current,agentType:"onboarding",eventType:"tool_call",eventData:{tool:"completeConversation",summary:t.summary}}),setTimeout(async()=>{r.status==="connected"&&await r.endSession(),p&&p()},1e3),"SUCCESS: Onboarding completed")}catch(c){return d.logError("tool","completeConversation exception",c),console.error("âŒ completeConversation exception:",c),`ERROR: ${c instanceof Error?c.message:"Unknown error"}`}},endConversation:async()=>{try{return d.info("tool","endConversation called",{conversationId:s.current}),await r.endSession(),d.info("tool","endConversation completed",{conversationId:s.current}),"Conversation ended successfully"}catch(t){return d.logError("tool","endConversation failed",t),`Error ending conversation: ${t instanceof Error?t.message:"Unknown error"}`}},navigateTo:async t=>{console.log("ðŸ§­ navigateTo called:",t);try{return l(t.page),`SUCCESS: Navigated to ${t.page}`}catch(n){return console.error("âŒ navigateTo error:",n),`ERROR: ${n instanceof Error?n.message:"Unknown error"}`}}}});a.useEffect(()=>(r.status==="connected"?y.current=setInterval(()=>{var t,n;if(r.isSpeaking){const c=((t=r.getOutputVolume)==null?void 0:t.call(r))||0;w(c)}else{const c=((n=r.getInputVolume)==null?void 0:n.call(r))||0;w(c)}},50):w(0),()=>{y.current&&clearInterval(y.current)}),[r.status,r.isSpeaking]),a.useEffect(()=>{const t=o;let n;r.isSpeaking?n="speaking":r.status==="connected"?n="listening":n="idle",t!==n&&(d.debug("state","Aperture state changed",{from:t,to:n,reason:r.isSpeaking?"agent_speaking":r.status,audioAmplitude:_}),f(n))},[r.isSpeaking,r.status,_]);const F=a.useCallback(async()=>{const t=d.startTimer();s.current=ae(),d.setContext(s.current,"onboarding"),d.info("session","Starting onboarding conversation",{conversationId:s.current,agentId:V.onboarding.agentId}),console.log("ðŸš€ Starting onboarding conversation"),g(!0),f("thinking");try{const{data:{session:n}}=await b.auth.getSession();if(!(n!=null&&n.user))throw d.error("session","Authentication required"),new Error("Not authenticated");d.debug("session","User authenticated",{userId:n.user.id});const c=await ne(V.onboarding.agentId);d.debug("session","Starting ElevenLabs session"),console.log("ðŸ¤– Starting onboarding agent"),await r.startSession({signedUrl:c}),d.info("session","Onboarding session started successfully",{duration:t.elapsed()}),f("listening")}catch(n){d.logError("session","Failed to start onboarding conversation",n),console.error("âŒ Failed to start onboarding:",n),C({title:"Connection Failed",description:"Could not start voice onboarding",variant:"destructive"}),M()}},[r,C]),M=a.useCallback(async()=>{d.info("session","Ending onboarding conversation"),console.log("ðŸ”š Ending onboarding conversation"),r.status==="connected"&&await r.endSession(),d.clearContext(),s.current="",v(""),u(""),g(!1),f("idle"),w(0)},[r]);a.useEffect(()=>()=>{r.status==="connected"&&r.endSession(),y.current&&clearInterval(y.current)},[]);const G=a.useCallback(t=>{r.sendContextualUpdate&&r.sendContextualUpdate(t)},[r]);return{apertureState:o,audioAmplitude:_,userTranscript:m,aiTranscript:x,showConversation:S,status:r.status,isSpeaking:r.isSpeaking,startConversation:F,endConversation:M,sendContextualUpdate:G}},be=({module:i,onComplete:p,onSwitchToForm:o})=>{const{apertureState:f,audioAmplitude:m,userTranscript:v,aiTranscript:x,startConversation:u,endConversation:S}=je({onComplete:p});return a.useEffect(()=>(u(),()=>{S()}),[]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px]",children:[e.jsx(oe,{state:f,audioAmplitude:m,size:"lg"}),e.jsxs("div",{className:"mt-8 space-y-4 w-full max-w-md",children:[v&&e.jsx("div",{className:"p-3 rounded-lg bg-accent/10 border border-accent/20",children:e.jsx("p",{className:"text-sm text-foreground/90",children:v})}),x&&e.jsx("div",{className:"p-3 rounded-lg bg-primary/10 border border-primary/20",children:e.jsx("p",{className:"text-sm text-foreground/90",children:x})})]})]}),e.jsxs(T,{variant:"outline",onClick:o,className:"w-full",children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Switch to form instead"]})]})},Se={core:"Welcome to Kaeva",nutrition:"Nutrition Profile",pantry:"Pantry Preferences",beauty:"Beauty Profile",pets:"Meet Your Pets",household:"Household Members"},Fe=({open:i,module:p,onClose:o,onComplete:f})=>{const[m,v]=a.useState("choose");a.useEffect(()=>{if(i){const g=localStorage.getItem("preferred_onboarding_mode");v(g||"choose")}},[i]);const x=g=>{localStorage.setItem("preferred_onboarding_mode",g),v(g)},u=()=>{f(),o(),v("choose")},S=()=>{const g={onComplete:u,onCancel:o};switch(p){case"core":return e.jsx(ge,{...g});case"nutrition":return e.jsx(xe,{...g});case"pantry":return e.jsx(pe,{...g});case"beauty":return e.jsx(fe,{...g});case"pets":return e.jsx(ve,{...g});case"household":return e.jsx(ye,{...g})}};return e.jsx(ie,{open:i,onOpenChange:o,children:e.jsxs(le,{side:"bottom",className:"h-[90vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsx(de,{children:Se[p]})}),m==="choose"&&e.jsxs("div",{className:"mt-8 space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Choose how you'd like to complete this"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>x("form"),className:"p-6 rounded-xl border border-border bg-background hover:border-primary/50 transition-colors",children:[e.jsx(K,{className:"w-8 h-8 text-primary mx-auto mb-3"}),e.jsx("p",{className:"font-medium text-sm mb-1",children:"Type It"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Fill out a quick form"})]}),e.jsxs("button",{onClick:()=>x("voice"),className:"p-6 rounded-xl border border-border bg-background hover:border-primary/50 transition-colors",children:[e.jsx(ue,{className:"w-8 h-8 text-primary mx-auto mb-3"}),e.jsx("p",{className:"font-medium text-sm mb-1",children:"Talk to Kaeva"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"30-second conversation"})]})]}),e.jsx(T,{variant:"ghost",onClick:o,className:"w-full text-muted-foreground",children:"Skip for now"})]}),m==="form"&&e.jsxs("div",{className:"mt-6",children:[S(),e.jsx(T,{variant:"ghost",onClick:()=>v("choose"),className:"w-full mt-4 text-muted-foreground",children:"Switch to voice instead"})]}),m==="voice"&&e.jsx("div",{className:"mt-6",children:e.jsx(be,{module:p,onComplete:u,onSwitchToForm:()=>v("form")})})]})})};export{Fe as O,q as u};
